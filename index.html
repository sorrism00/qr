<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR 비밀번호 복호화기</title>

    <!-- PWA: Manifest Link -->
    <link rel="manifest" id="pwa-manifest">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="QR 복호화기">

    <!-- CryptoJS 라이브러리 (AES 복호화) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <!-- html5-qrcode 라이브러리 (QR 코드 스캔) -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; color: #333; text-align: center; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 600px; margin: 20px auto; }
        h1 { color: #0056b3; margin-bottom: 20px; }
        #qr-reader { width: 100%; max-width: 400px; margin: 20px auto; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; margin-top: 10px; }
        button:hover { background-color: #0056b3; }
        .result-box, .error-box { margin-top: 30px; padding: 15px; border-radius: 4px; font-weight: bold; min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .result-box { border: 1px solid #ccc; background-color: #e2f0cb; color: #28a745; word-wrap: break-word; text-align: left; }
        .error-box { border: 1px solid #dc3545; background-color: #f8d7da; color: #dc3545; text-align: left; }
        #decryptionKeyInput { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .key-input-group { margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>QR 비밀번호 복호화기</h1>
        <div class="key-input-group">
            <input type="password" id="decryptionKeyInput" placeholder="암호화 키의 마지막 4자리를 입력하세요." inputmode="text" maxlength="4">
        </div>
        <div id="qr-reader"></div>
        <div id="qr-reader-results">
            <div id="resultBox" class="result-box"><p>스캔 대기 중...</p></div>
        </div>
        <div id="errorBox" class="error-box" style="display: none;"></div>
        <button id="startScanButton">스캔 시작</button>
        <button id="stopScanButton" style="display: none;">스캔 중지</button>
    </div>

    <!-- PWA Manifest & Service Worker Scripts are omitted for brevity but should be included as before -->
    <script>
        const KEY_PREFIX = "1q2w3e4r5t6y";
        const DECRYPTION_KEY_INPUT_ID = "decryptionKeyInput";
        const QR_READER_ELEMENT_ID = "qr-reader";
        const RESULT_BOX_ID = "resultBox";
        const ERROR_BOX_ID = "errorBox";
        const START_SCAN_BUTTON_ID = "startScanButton";
        const STOP_SCAN_BUTTON_ID = "stopScanButton";

        const resultBox = document.getElementById(RESULT_BOX_ID);
        const errorBox = document.getElementById(ERROR_BOX_ID);
        const startScanButton = document.getElementById(START_SCAN_BUTTON_ID);
        const stopScanButton = document.getElementById(STOP_SCAN_BUTTON_ID);
        const decryptionKeyInput = document.getElementById(DECRYPTION_KEY_INPUT_ID);
        
        // --- 스캐너 객체를 스크립트 로드 시 단 한 번만 생성 ---
        const html5QrCode = new Html5Qrcode(QR_READER_ELEMENT_ID);

        function decryptData(encryptedBase64Data, keyString) {
            try {
                const keyBytes = CryptoJS.enc.Utf8.parse(keyString);
                if (keyBytes.sigBytes !== 16) { throw new Error("완성된 키의 길이는 16바이트여야 합니다."); }
                const rawData = CryptoJS.enc.Base64.parse(encryptedBase64Data);
                const iv = CryptoJS.lib.WordArray.create(rawData.words.slice(0, 4));
                const ciphertext = CryptoJS.lib.WordArray.create(rawData.words.slice(4));
                const decrypted = CryptoJS.AES.decrypt({ ciphertext: ciphertext }, keyBytes, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.NoPadding });
                let decryptedString = decrypted.toString(CryptoJS.enc.Utf8).replace(/\0+$/, '');
                if (!decryptedString) { throw new Error("복호화된 데이터가 비어 있습니다. 올바른 키와 QR 코드인지 확인하세요."); }
                return decryptedString;
            } catch (e) {
                console.error("복호화 오류:", e);
                throw new Error(`복호화 실패: ${e.message || e}`);
            }
        }

        const onScanSuccess = (decodedText, decodedResult) => {
            console.log(`QR Code detected: ${decodedText}`);
            stopScanning();

            resultBox.innerHTML = `<p><strong>QR 데이터:</strong> ${decodedText}</p>`;
            errorBox.style.display = 'none';
            errorBox.innerHTML = '';
            
            const lastFourChars = decryptionKeyInput.value.trim();
            const fullKey = KEY_PREFIX + lastFourChars;

            try {
                const decryptedPassword = decryptData(decodedText, fullKey);
                resultBox.innerHTML = `<p><strong>복호화된 비밀번호:</strong> <span style="color: blue;">${decryptedPassword}</span></p>`;
            } catch (e) {
                errorBox.style.display = 'block';
                errorBox.innerHTML = `<p>${e.message}</p>`;
                resultBox.innerHTML = '<p>복호화 실패</p>';
            }
        };

        const onScanFailure = (error) => {};

        async function startScanning() {
            const lastFourChars = decryptionKeyInput.value.trim();
            if (lastFourChars.length !== 4) {
                errorBox.style.display = 'block';
                errorBox.innerHTML = '<p>오류: 키의 마지막 4자리를 입력해야 합니다.</p>';
                return;
            }

            resultBox.innerHTML = '<p>카메라 권한을 요청합니다...</p>';
            errorBox.style.display = 'none';
            errorBox.innerHTML = '';
            startScanButton.style.display = 'none';
            stopScanButton.style.display = 'inline-block';
            decryptionKeyInput.disabled = true;

            try {
                const cameras = await Html5Qrcode.getCameras();
                resultBox.innerHTML = `<p>${cameras.length}개의 카메라를 찾았습니다. 후면 카메라를 선택합니다...</p>`;

                if (cameras && cameras.length) {
                    let cameraId;
                    const rearCamera = cameras.find(camera => camera.label.toLowerCase().includes('back') || camera.label.toLowerCase().includes('rear') || camera.label.toLowerCase().includes('후면'));
                    if (rearCamera) {
                        cameraId = rearCamera.id;
                        console.log(`후면 카메라를 찾았습니다: ${rearCamera.label}`);
                    } else {
                        cameraId = cameras[cameras.length - 1].id;
                        console.log("후면 카메라를 특정하지 못해 마지막 카메라를 사용합니다.");
                    }
                    
                    resultBox.innerHTML = '<p>카메라 화면을 시작합니다...</p>';

                    await html5QrCode.start(
                        cameraId,
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        onScanSuccess,
                        onScanFailure
                    );
                    
                    resultBox.innerHTML = '<p>스캔 중...</p>';

                } else {
                    throw new Error("사용 가능한 카메라를 찾을 수 없습니다.");
                }
            } catch (err) {
                errorBox.style.display = 'block';
                errorBox.innerHTML = `<p>카메라 시작 오류: ${err.message || err}</p>`;
                resultBox.innerHTML = '<p>스캔 실패</p>';
                console.error("Camera start failed:", err);
                await stopScanning(); // 오류 발생 시 UI 원상 복구
            }
        }

        async function stopScanning() {
            if (html5QrCode && html5QrCode.isScanning) {
                try {
                    await html5QrCode.stop();
                    console.log("QR Code scanning stopped.");
                } catch (err) {
                    console.error("Failed to stop QR Code scanning:", err);
                }
            }
            // 스캔이 중지되거나 실패했을 때 항상 UI를 초기 상태로 되돌립니다.
            startScanButton.style.display = 'inline-block';
            stopScanButton.style.display = 'none';
            decryptionKeyInput.disabled = false;
        }

        startScanButton.addEventListener('click', startScanning);
        stopScanButton.addEventListener('click', stopScanning);

        resultBox.innerHTML = '<p>키의 마지막 4자리를 입력하고 "스캔 시작"을 눌러주세요.</p>';
    </script>
</body>
</html>
